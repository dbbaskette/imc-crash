spring:
  application:
    name: crash-rabbitmq-sink

  # Spring Cloud Stream configuration
  cloud:
    function:
      definition: processTelemetry
    stream:
      bindings:
        # Input: Vehicle accident events from telemetry exchange
        processTelemetry-in-0:
          destination: ${TELEMETRY_INPUT_DESTINATION:telematics_exchange}
          group: ${TELEMETRY_INPUT_GROUP:crash-sink-group}
          consumer:
            concurrency: ${CONSUMER_CONCURRENCY:1}

        # Output 0: vehicle_events queue (original format for JDBC Sink compatibility)
        processTelemetry-out-0:
          destination: ${VEHICLE_EVENTS_DESTINATION:vehicle_events}

        # Output 1: fnol_reports queue (enriched reports for claims systems)
        processTelemetry-out-1:
          destination: ${FNOL_REPORTS_DESTINATION:fnol_reports}

      rabbit:
        bindings:
          processTelemetry-in-0:
            consumer:
              exchangeType: fanout
              bindingRoutingKey: "#"

          processTelemetry-out-0:
            producer:
              exchangeType: topic
              routingKeyExpression: "headers.containsKey('severity') ? 'vehicle.accident.' + headers['severity'].toString().toLowerCase() : 'vehicle.accident.unknown'"

          processTelemetry-out-1:
            producer:
              exchangeType: topic
              routingKeyExpression: "headers.containsKey('severity') ? 'fnol.' + headers['severity'].toString().toLowerCase() : 'fnol.unknown'"

  # JPA/Database configuration
  datasource:
    url: ${DATABASE_URL:jdbc:postgresql://localhost:5432/crash}
    username: ${DATABASE_USERNAME:crash}
    password: ${DATABASE_PASSWORD:crash}
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

  # Spring AI configuration
  ai:
    openai:
      api-key: ${OPENAI_API_KEY:}
      base-url: https://api.openai.com/v1
      chat:
        options:
          model: ${OPENAI_MODEL:gpt-5-nano}
          temperature: ${OPENAI_TEMPERATURE:0.3}
    anthropic:
      api-key: ${ANTHROPIC_API_KEY:}
      chat:
        options:
          model: ${ANTHROPIC_MODEL:claude-3-5-sonnet-20241022}
          temperature: ${ANTHROPIC_TEMPERATURE:0.3}
        request-timeout: 60s
    mcp:
      client:
        enabled: true
        type: SYNC
        request-timeout: 30s
        toolcallback:
          enabled: true
        streamable-http:
          connections:
            impact-analyst:
              url: ${MCP_IMPACT_ANALYST_URL:http://localhost:8081}
              endpoint: /mcp
            environment:
              url: ${MCP_ENVIRONMENT_URL:http://localhost:8082}
              endpoint: /mcp
            policy:
              url: ${MCP_POLICY_URL:http://localhost:8083}
              endpoint: /mcp
            services:
              url: ${MCP_SERVICES_URL:http://localhost:8084}
              endpoint: /mcp
            communications:
              url: ${MCP_COMMUNICATIONS_URL:http://localhost:8085}
              endpoint: /mcp

# Embabel agent configuration
embabel:
  models:
    default-llm: claude-sonnet-4-5
  agent:
    platform:
      scanning:
        packages: com.embabel.agent,com.insurancemegacorp.crashsink

# Server configuration
server:
  port: ${PORT:8086}

# Actuator/Management endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      application: ${spring.application.name}

# Logging
logging:
  level:
    com.insurancemegacorp: ${LOG_LEVEL:INFO}
    com.embabel: INFO
    org.springframework.ai: DEBUG
    org.springframework.ai.openai: TRACE
    org.springframework.web.client: DEBUG
    org.springframework.cloud.stream: INFO

---
# Local/Docker profile
spring:
  config:
    activate:
      on-profile: local
  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}
    port: ${RABBITMQ_PORT:5672}
    username: ${RABBITMQ_USERNAME:guest}
    password: ${RABBITMQ_PASSWORD:guest}

---
# Cloud Foundry profile
spring:
  config:
    activate:
      on-profile: cloud
  # CF will auto-configure RabbitMQ and PostgreSQL from bound services
