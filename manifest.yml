# IMC-CRASH Cloud Foundry Manifest
# Deploy with: cf push --vars-file vars.yaml
#
# All API keys, credentials, and database config are injected from vars.yaml.
# Routes are auto-generated by CF based on app name and default domain.
# MCP URLs use internal container-to-container networking via app names.
# NOTE: RabbitMQ is managed by SCDF for crash-sink-scdf, not needed here.

applications:
  # NOTE: crash-sink is for local Docker runs only
  # For CF/SCDF, use crash-sink-scdf deployed via telemetry-streams-agentic.yml

  # GOAP orchestrator - single instance for WebSocket consistency
  - name: crash-orchestrator
    path: crash-orchestrator/target/crash-orchestrator.jar
    memory: 1G
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      # Database Configuration (Greenplum)
      SPRING_DATASOURCE_URL: ((database.url))
      SPRING_DATASOURCE_USERNAME: ((database.username))
      SPRING_DATASOURCE_PASSWORD: ((database.password))
      # LLM Configuration
      GOOGLE_API_KEY: ((google.api_key))
      GOOGLE_MODEL: ((google.model))
      # Internal routes to MCP servers (container-to-container)
      MCP_IMPACT_ANALYST_URL: https://crash-impact-analyst.apps.tas-ndc.kuhn-labs.com
      MCP_ENVIRONMENT_URL: https://crash-environment.apps.tas-ndc.kuhn-labs.com
      MCP_POLICY_URL: https://crash-policy.apps.tas-ndc.kuhn-labs.com
      MCP_SERVICES_URL: https://crash-services.apps.tas-ndc.kuhn-labs.com
      MCP_COMMUNICATIONS_URL: https://crash-communications.apps.tas-ndc.kuhn-labs.com

  # Impact analysis MCP server
  - name: crash-impact-analyst
    path: crash-mcp-impact-analyst/target/crash-mcp-impact-analyst.jar
    memory: 768M
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      GOOGLE_API_KEY: ((google.api_key))
      GOOGLE_MODEL: ((google.model))

  # Environment context MCP server
  - name: crash-environment
    path: crash-mcp-environment/target/crash-mcp-environment.jar
    memory: 768M
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      GOOGLE_API_KEY: ((google.api_key))
      GOOGLE_MODEL: ((google.model))

  # Policy lookup MCP server
  - name: crash-policy
    path: crash-mcp-policy/target/crash-mcp-policy.jar
    memory: 768M
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      # Database Configuration (Greenplum)
      SPRING_DATASOURCE_URL: ((database.url))
      SPRING_DATASOURCE_USERNAME: ((database.username))
      SPRING_DATASOURCE_PASSWORD: ((database.password))

  # Services finder MCP server
  - name: crash-services
    path: crash-mcp-services/target/crash-mcp-services.jar
    memory: 768M
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      TOMTOM_API_KEY: ((tomtom.api_key))
      GEOAPIFY_API_KEY: ((geoapify.api_key))

  # Communications MCP server
  - name: crash-communications
    path: crash-mcp-communications/target/crash-mcp-communications.jar
    memory: 768M
    instances: 1
    buildpacks:
      - java_buildpack_offline
    env:
      SPRING_PROFILES_ACTIVE: cloud
      JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 21.+ } }'
      # Database Configuration (Greenplum)
      SPRING_DATASOURCE_URL: ((database.url))
      SPRING_DATASOURCE_USERNAME: ((database.username))
      SPRING_DATASOURCE_PASSWORD: ((database.password))
      DEMO_MODE: ((demo.mode))
      TWILIO_ACCOUNT_SID: ((twilio.account_sid))
      TWILIO_AUTH_TOKEN: ((twilio.auth_token))
      TWILIO_FROM_NUMBER: ((twilio.from_number))
      GMAIL_USERNAME: ((gmail.username))
      GMAIL_APP_PASSWORD: ((gmail.app_password))
      GMAIL_ADJUSTER_EMAIL: ((gmail.adjuster_email))
      GMAIL_CUSTOMER_EMAIL: ((gmail.customer_email))

  # NOTE: crash-sink-scdf is deployed via SCDF stream (telemetry-streams-agentic.yml)
  # not directly via cf push

  # React UI (static build)
  - name: crash-ui
    path: crash-ui
    memory: 64M
    instances: 1
    buildpacks:
      - staticfile_buildpack
